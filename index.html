<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¢Ù¹Ø§ Ú†Ú©ÛŒ Ø±Ø¬Ø³Ù¹Ø± Ù¾Ø±Ùˆ Ù¾Ù„Ø³ v16</title>
    <style>
        :root { --primary: #2e7d32; --dark: #263238; --accent: #f1c40f; --danger: #d32f2f; --blue: #1565c0; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f4f7; padding: 10px; margin: 0; direction: rtl; }
        .container { background: white; max-width: 900px; margin: auto; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); padding: 15px; }
        h2, h3 { text-align: center; color: var(--primary); margin-bottom: 10px; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        
        .form-box { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 20px; }
        input { padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; width: 90%; }
        .btn-main { grid-column: 1 / -1; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: var(--dark); color: white; padding: 12px; border-radius: 8px; text-align: center; border-bottom: 4px solid var(--accent); }
        .stat-card p { font-size: 18px; font-weight: bold; color: var(--accent); margin: 5px 0; }
        .stat-card span { font-size: 12px; display: block; color: #ddd; }

        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 10px; background: #eee; border-radius: 5px; overflow: hidden; }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: bold; color: #666; }
        .tab.active { border-bottom: 4px solid var(--primary); color: var(--primary); background: #fff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        table { width: 100%; border-collapse: collapse; margin-top: 5px; background: white; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; font-size: 13px; }
        th { background: #37474f; color: white; }
        .btn-pay { background: var(--blue); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .btn-del { color: var(--danger); font-weight: bold; border: none; background: none; cursor: pointer; font-size: 18px; }
        
        #receipt { background: #fff9c4; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 2px dashed var(--primary); display: none; }
    </style>
</head>
<body onload="init()">

<div class="container">
    <h2>Ø¢Ù¹Ø§ Ú†Ú©ÛŒ ÚˆÛŒØ¬ÛŒÙ¹Ù„ Ø±Ø¬Ø³Ù¹Ø±</h2>

    <div style="background:#fff3e0; padding:10px; border-radius:8px; margin-bottom:15px; border:1px solid #ffe0b2; display:flex; justify-content:space-between; align-items:center;">
        <span style="font-size:12px; font-weight:bold; color:#e65100;">ÚˆÛŒÙ¹Ø§ Ø¨ÛŒÚ© Ø§Ù¾:</span>
        <div>
            <button onclick="exportData()" style="background:#e65100; color:white; border:none; padding:8px 12px; border-radius:5px; cursor:pointer;">ğŸ“¤ ÙØ§Ø¦Ù„ Ù…Ø­ÙÙˆØ¸ Ú©Ø±ÛŒÚº</button>
            <button onclick="importData()" style="background:#5d4037; color:white; border:none; padding:8px 12px; border-radius:5px; cursor:pointer;">ğŸ“¥ Ø±ÛŒ Ø§Ø³Ù¹ÙˆØ±</button>
        </div>
    </div>

    <div class="form-box">
        <h3 style="grid-column: 1/-1; border:none; color:var(--primary); margin:0;">Ú¯Ù†Ø¯Ù… Ù¾Ø³Ø§Ø¦ÛŒ</h3>
        <input type="text" id="cName" placeholder="Ú¯Ø§ÛÚ© Ú©Ø§ Ù†Ø§Ù…">
        <input type="number" id="wWeight" placeholder="Ú¯Ù†Ø¯Ù… ÙˆØ²Ù† (Ú©Ù„Ùˆ)">
        <input type="number" id="aRate" value="120" placeholder="Ø¢Ù¹Ø§ Ø±ÛŒÙ¹">
        <div style="grid-column: 1/-1; display:flex; gap:10px; font-size:12px;">
            <label><input type="checkbox" id="noCln"> ØµÙØ§Ø¦ÛŒ Ù†ÛÛŒÚº</label>
            <label><input type="checkbox" id="noKat"> Ú©Ù¹ÙˆØªÛŒ Ù†ÛÛŒÚº</label>
            <label><input type="checkbox" id="payByA"> Ø¨Ù„ Ø¨Ø°Ø±ÛŒØ¹Û Ø¢Ù¹Ø§</label>
        </div>
        <button class="btn-main" onclick="calculate()">Ø­Ø³Ø§Ø¨ Ú©Ø±ÛŒÚº</button>
    </div>

    <div id="receipt">
        <h4 style="text-align:center; margin:0 0 10px 0;">Ø¹Ø§Ø±Ø¶ÛŒ Ø±Ø³ÛŒØ¯</h4>
        <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:10px; border-bottom:1px solid #ccc; padding-bottom:5px;">
            <span>Ù†Ù‚Ø¯ Ø¨Ù„: <span id="rBill">0</span> Ø±ÙˆÙ¾Û’</span>
            <span>ØµØ§Ù Ø¢Ù¹Ø§: <span id="rNet">0</span> Ú©Ù„Ùˆ</span>
        </div>
        <div style="font-size:12px; margin-bottom:10px;">
            Ú©Ù¹ÙˆØªÛŒ ÙˆØ²Ù†: <span id="rKat">0</span> Ú©Ù„Ùˆ
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <button onclick="saveEntry('Paid')" style="background:var(--primary); color:white; padding:10px; border:none; border-radius:5px; font-weight:bold;">Ù†Ù‚Ø¯ ÙˆØµÙˆÙ„ÛŒ</button>
            <button onclick="saveEntry('Credit')" style="background:var(--danger); color:white; padding:10px; border:none; border-radius:5px; font-weight:bold;">Ø§Ø¯Ú¾Ø§Ø± Ú©Ú¾Ø§ØªÛ</button>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="openTab(event, 'tab1')">Ø±ÙˆØ²Ù…Ø±Û</div>
        <div class="tab" onclick="openTab(event, 'tab2')">Ø§Ø¯Ú¾Ø§Ø± Ú©Ú¾Ø§ØªÛ</div>
        <div class="tab" onclick="openTab(event, 'tab3')">Ù…Ø¬Ù…ÙˆØ¹ÛŒ Ø±Ù¾ÙˆØ±Ù¹</div>
    </div>

    <div id="tab1" class="tab-content active">
        <table id="dailyTbl">
            <thead><tr><th>Ù†Ø§Ù…</th><th>ÙˆØ²Ù†</th><th>Ø¨Ù„</th><th>Ø­Ø§Ù„Øª</th><th>Ø­Ø°Ù</th></tr></thead>
            <tbody id="dailyBody"></tbody>
        </table>
    </div>

    <div id="tab2" class="tab-content">
        <table id="khataTbl">
            <thead><tr><th>Ù†Ø§Ù…</th><th>Ø¨Ù‚Ø§ÛŒØ§ Ø§Ø¯Ú¾Ø§Ø±</th><th>Ø§ÛŒÚ©Ø´Ù†</th></tr></thead>
            <tbody id="khataBody"></tbody>
        </table>
    </div>

    <div id="tab3" class="tab-content">
        <div class="stats-grid">
            <div class="stat-card"><h4>Ú©Ù„ Ú¯Ù†Ø¯Ù…</h4><p id="sW">0</p><span id="sM">0 Ù…Ù†</span></div>
            <div class="stat-card"><h4>Ú©Ù„ Ú©Ù¹ÙˆØªÛŒ</h4><p id="sK" style="color:#2ecc71">0</p><span>Ú©Ù„Ùˆ Ú¯Ø±Ø§Ù…</span></div>
            <div class="stat-card"><h4>Ù†Ù‚Ø¯ Ø¢Ù…Ø¯Ù†</h4><p id="sC">0</p><span>Ø±ÙˆÙ¾Û’</span></div>
            <div class="stat-card"><h4>Ù…Ø§Ø±Ú©ÛŒÙ¹ Ø§Ø¯Ú¾Ø§Ø±</h4><p id="sP" style="color:red">0</p><span>Ø±ÙˆÙ¾Û’</span></div>
        </div>
    </div>

    <br><hr>
    <div class="form-box" style="border: 2px solid var(--blue); margin-top:20px;">
        <h3 style="grid-column:1/-1; border:none; color:var(--blue); margin:0;">Ø¢Ù¹Ø§ Ø§Ø¯Ú¾Ø§Ø± Ø±Ø¬Ø³Ù¹Ø± (Ø§Ù„Ú¯)</h3>
        <input type="text" id="sName" placeholder="Ø®Ø±ÛŒØ¯Ø§Ø± Ú©Ø§ Ù†Ø§Ù…">
        <input type="number" id="sWeight" placeholder="Ø¢Ù¹Ø§ ÙˆØ²Ù† (Ú©Ù„Ùˆ)">
        <input type="number" id="sRate" value="130" placeholder="Ø±ÛŒÙ¹">
        <button class="btn-main" style="background:var(--blue);" onclick="saveSale()">Ø¢Ù¹Ø§ ÙØ±ÙˆØ®Øª Ø³ÛŒÙˆ Ú©Ø±ÛŒÚº</button>
    </div>

    <div style="overflow-x:auto;">
        <table id="saleTbl">
            <thead><tr style="background:var(--blue); color:white;"><th>ØªØ§Ø±ÛŒØ®</th><th>Ù†Ø§Ù…</th><th>ÙˆØ²Ù†</th><th>Ø¨Ù‚Ø§ÛŒØ§</th><th>Ø§ÛŒÚ©Ø´Ù†</th></tr></thead>
            <tbody id="saleBody"></tbody>
        </table>
    </div>
</div>

<script>
    let pisaiDB = JSON.parse(localStorage.getItem('PISAI_DATA_V2')) || [];
    let salesDB = JSON.parse(localStorage.getItem('SALES_DATA_V2')) || [];
    let temp = null;

    function init() { render(); }

    function calculate() {
        const name = document.getElementById('cName').value.trim();
        const weight = parseFloat(document.getElementById('wWeight').value);
        const rate = parseFloat(document.getElementById('aRate').value);
        
        if(!name || isNaN(weight) || weight <= 0) return alert("Ù†Ø§Ù… Ø§ÙˆØ± Ø¯Ø±Ø³Øª ÙˆØ²Ù† Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚº");

        // 1. Ù¾Ø³Ø§Ø¦ÛŒ + ØµÙØ§Ø¦ÛŒ (4.2 Ø±ÙˆÙ¾Û’ ÙÛŒ Ú©Ù„Ùˆ)
        let totalBill = weight * 4.2;
        
        // 2. Ú©Ù¹ÙˆØªÛŒ ÙˆØ²Ù† (5%)
        let katotiWeight = document.getElementById('noKat').checked ? 0 : (weight * 0.05);
        
        // 3. ØµØ§Ù Ø¢Ù¹Ø§ (ÙˆØ²Ù† - Ú©Ù¹ÙˆØªÛŒ)
        let netFlour = weight - katotiWeight;

        // 4. Ø§Ú¯Ø± Ø¨Ù„ Ø¢Ù¹Û’ Ø³Û’ Ú©Ø§Ù¹Ù†Ø§ ÛÛ’
        if (document.getElementById('payByA').checked) {
            let flourForBill = totalBill / rate;
            netFlour -= flourForBill;
            totalBill = 0; // Ù†Ù‚Ø¯ Ø¨Ù„ Ø²ÛŒØ±Ùˆ ÛÙˆ Ú¯ÛŒØ§
        }

        temp = { 
            id: Date.now(), 
            name, 
            weight, 
            bill: totalBill, 
            kat: katotiWeight, 
            paid: 0, 
            bal: totalBill, 
            date: new Date().toLocaleString('ur-PK') 
        };

        document.getElementById('rBill').innerText = totalBill.toFixed(0);
        document.getElementById('rNet').innerText = netFlour.toFixed(2);
        document.getElementById('rKat').innerText = katotiWeight.toFixed(2);
        document.getElementById('receipt').style.display = 'block';
    }

    function saveEntry(status) {
        if(status === 'Paid') { temp.paid = temp.bill; temp.bal = 0; }
        pisaiDB.push(temp);
        localStorage.setItem('PISAI_DATA_V2', JSON.stringify(pisaiDB));
        document.getElementById('receipt').style.display = 'none';
        // Ø§Ù† Ù¾Ù¹ ÙÛŒÙ„ÚˆØ² Ø®Ø§Ù„ÛŒ Ú©Ø±Ù†Ø§
        document.getElementById('cName').value = '';
        document.getElementById('wWeight').value = '';
        render();
    }

    function saveSale() {
        const name = document.getElementById('sName').value.trim();
        const weight = parseFloat(document.getElementById('sWeight').value);
        const rate = parseFloat(document.getElementById('sRate').value);
        
        if(!name || isNaN(weight)) return alert("Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¯Ø±Ø³Øª Ú©Ø±ÛŒÚº");

        let sale = { 
            id: Date.now(), 
            name, 
            weight, 
            bill: weight * rate, 
            paid: 0, 
            bal: weight * rate, 
            date: new Date().toLocaleString('ur-PK') 
        };
        salesDB.push(sale);
        localStorage.setItem('SALES_DATA_V2', JSON.stringify(salesDB));
        document.getElementById('sName').value = '';
        document.getElementById('sWeight').value = '';
        render();
    }

    function render() {
        // Pisai Daily
        const dBody = document.getElementById('dailyBody');
        dBody.innerHTML = '';
        pisaiDB.slice().reverse().forEach(i => {
            dBody.innerHTML += `<tr>
                <td>${i.name}</td>
                <td>${i.weight}</td>
                <td>${i.bill.toFixed(0)}</td>
                <td style="color:${i.bal>0?'red':'green'}; font-weight:bold">${i.bal>0?'Ø§Ø¯Ú¾Ø§Ø±':'Ù†Ù‚Ø¯'}</td>
                <td><button class="btn-del" onclick="del(${i.id},'p')">Ã—</button></td>
            </tr>`;
        });

        // Khata
        const kBody = document.getElementById('khataBody');
        kBody.innerHTML = '';
        let groups = {};
        pisaiDB.forEach(i => { if(i.bal > 0) groups[i.name] = (groups[i.name] || 0) + i.bal; });
        for(let n in groups) {
            kBody.innerHTML += `<tr>
                <td>${n}</td>
                <td style="color:red; font-weight:bold;">${groups[n].toFixed(0)}</td>
                <td><button class="btn-pay" onclick="receivePisai('${n}')">ÙˆØµÙˆÙ„</button></td>
            </tr>`;
        }

        // Sales Table
        const sBody = document.getElementById('saleBody');
        sBody.innerHTML = '';
        salesDB.slice().reverse().forEach(i => {
            sBody.innerHTML += `<tr>
                <td>${i.date.split(',')[0]}</td>
                <td>${i.name}</td>
                <td>${i.weight}</td>
                <td style="color:red; font-weight:bold">${i.bal.toFixed(0)}</td>
                <td><button class="btn-pay" onclick="receiveSale(${i.id})">ÙˆØµÙˆÙ„</button><button class="btn-del" onclick="del(${i.id},'s')">Ã—</button></td>
            </tr>`;
        });

        updateStats();
    }

    function receivePisai(name) {
        let amt = parseFloat(prompt(`${name} Ø³Û’ ÙˆØµÙˆÙ„ Ú©ÛŒ Ú¯Ø¦ÛŒ Ø±Ù‚Ù…:`));
        if(isNaN(amt) || amt <= 0) return;
        pisaiDB.filter(i => i.name === name && i.bal > 0).forEach(i => {
            let take = Math.min(amt, i.bal);
            i.paid += take; i.bal -= take; amt -= take;
        });
        localStorage.setItem('PISAI_DATA_V2', JSON.stringify(pisaiDB));
        render();
    }

    function receiveSale(id) {
        let amt = parseFloat(prompt("ÙˆØµÙˆÙ„ÛŒ Ø±Ù‚Ù… Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚº:"));
        if(isNaN(amt) || amt <= 0) return;
        salesDB.forEach(i => { if(i.id === id) { i.paid += amt; i.bal -= amt; } });
        localStorage.setItem('SALES_DATA_V2', JSON.stringify(salesDB));
        render();
    }

    function del(id, type) {
        if(!confirm("Ú©ÛŒØ§ Ø¢Ù¾ Ø­Ø°Ù Ú©Ø±Ù†Ø§ Ú†Ø§ÛØªÛ’ ÛÛŒÚºØŸ")) return;
        if(type === 'p') pisaiDB = pisaiDB.filter(i => i.id !== id);
        else salesDB = salesDB.filter(i => i.id !== id);
        localStorage.setItem('PISAI_DATA_V2', JSON.stringify(pisaiDB));
        localStorage.setItem('SALES_DATA_V2', JSON.stringify(salesDB));
        render();
    }

    function updateStats() {
        let w = 0, c = 0, p = 0, k = 0;
        pisaiDB.forEach(i => { w += i.weight; c += i.paid; p += i.bal; k += i.kat; });
        salesDB.forEach(i => { c += i.paid; p += i.bal; });
        document.getElementById('sW').innerText = w.toFixed(1) + " Ú©Ù„Ùˆ";
        document.getElementById('sM').innerText = (w/40).toFixed(2) + " Ù…Ù†";
        document.getElementById('sK').innerText = k.toFixed(2) + " Ú©Ù„Ùˆ";
        document.getElementById('sC').innerText = c.toFixed(0);
        document.getElementById('sP').innerText = p.toFixed(0);
    }

    function openTab(e, id) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        e.currentTarget.classList.add('active');
    }

    function exportData() {
        const allData = { 
            pisai: JSON.parse(localStorage.getItem('PISAI_DATA_V2')) || [], 
            sales: JSON.parse(localStorage.getItem('SALES_DATA_V2')) || [] 
        };
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allData));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "chaki_backup_" + new Date().toLocaleDateString() + ".json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function importData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.onchange = e => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.readAsText(file);
            reader.onload = event => {
                const imported = JSON.parse(event.target.result);
                if(confirm("Ù¾Ø±Ø§Ù†Ø§ ÚˆÛŒÙ¹Ø§ Ù„ÙˆÚˆ Ú©Ø±ÛŒÚºØŸ Ù…ÙˆØ¬ÙˆØ¯Û ÚˆÛŒÙ¹Ø§ Ù…Ù¹ Ø¬Ø§Ø¦Û’ Ú¯Ø§Û”")) {
                    localStorage.setItem('PISAI_DATA_V2', JSON.stringify(imported.pisai));
                    localStorage.setItem('SALES_DATA_V2', JSON.stringify(imported.sales));
                    location.reload();
                }
            };
        };
        input.click();
    }
</script>
</body>
    </html>
    
