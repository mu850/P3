<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¢Ù¹Ø§ Ú†Ú©ÛŒ Ø±Ø¬Ø³Ù¹Ø± Ù¾Ø±Ùˆ</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --primary: #2e7d32; --dark: #263238; --accent: #f1c40f; --danger: #d32f2f; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f4f7f6; margin: 0; direction: rtl; padding: 10px; }
        .container { background: white; max-width: 900px; margin: auto; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); padding: 15px; }
        h2 { text-align: center; color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        /* Form Box */
        .form-box { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; background: #fff; padding: 15px; border-radius: 10px; border: 1px solid #ddd; margin-bottom: 20px; }
        .f-group { display: flex; flex-direction: column; }
        label { font-weight: bold; margin-bottom: 5px; color: #444; }
        input { padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }
        .checkboxes { grid-column: 1 / -1; display: flex; flex-wrap: wrap; gap: 10px; background: #e8f5e9; padding: 10px; border-radius: 8px; }
        .btn-calc { grid-column: 1 / -1; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; }

        /* Receipt Panel */
        #resPanel { background: var(--dark); color: white; padding: 15px; border-radius: 10px; margin-top: 15px; display: none; border-right: 5px solid var(--accent); }
        .res-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #444; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .btn-nqd { background: #27ae60; color: white; grid-column: span 2; padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .btn-udhaar { background: #e67e22; color: white; padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }

        /* Navigation Tabs */
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-top: 20px; overflow-x: auto; background: #eee; border-radius: 8px 8px 0 0; }
        .tab-btn { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: bold; color: #666; white-space: nowrap; }
        .tab-btn.active { border-bottom: 4px solid var(--primary); color: var(--primary); background: #fff; }
        .tab-content { display: none; padding-top: 15px; }
        .tab-content.active { display: block; }

        /* Tables & UI */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; font-size: 14px; }
        th { background: #37474f; color: white; }
        .btn-del { color: var(--danger); cursor: pointer; font-weight: bold; background: none; border: none; font-size: 20px; }
        .btn-action { background: #1565c0; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin: 2px; }

        /* Stats & Backup */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .stat-card { background: var(--dark); color: white; padding: 15px; border-radius: 10px; text-align: center; }
        .stat-card p { font-size: 18px; font-weight: bold; color: var(--accent); margin: 5px 0; }
        .backup-bar { background: #fff3e0; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; border: 1px solid #ffe0b2; }

        @media print { .no-print { display: none; } }
    </style>
</head>
<body onload="initApp()">

<div class="container">
    <div class="no-print">
        <h2>Ø¢Ù¹Ø§ Ú†Ú©ÛŒ ÚˆÛŒØ¬ÛŒÙ¹Ù„ Ø±Ø¬Ø³Ù¹Ø±</h2>
        
        <div class="backup-bar">
            <span style="width:100%; font-size:12px; font-weight:bold; color:#e65100;">ÚˆÛŒÙ¹Ø§ Ù…Ø­ÙÙˆØ¸ Ø±Ú©Ú¾Ù†Û’ Ú©Û’ Ù„ÛŒÛ’ Ø¨ÛŒÚ© Ø§Ù¾ ÙØ§Ø¦Ù„ Ø¨Ù†Ø§Ø¦ÛŒÚº:</span>
            <button onclick="exportData()" class="btn-action" style="background:#0277bd">ğŸ“¤ ÙØ§Ø¦Ù„ Ù…Ø­ÙÙˆØ¸ Ú©Ø±ÛŒÚº</button>
            <button onclick="importData()" class="btn-action" style="background:#6a1b9a">ğŸ“¥ ÙØ§Ø¦Ù„ Ù„ÙˆÚˆ Ú©Ø±ÛŒÚº</button>
        </div>

        <div class="form-box">
            <div class="f-group"><label>Ú¯Ø§ÛÚ© Ú©Ø§ Ù†Ø§Ù…</label><input type="text" id="cName" placeholder="Ù†Ø§Ù… Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚº" list="custNames"><datalist id="custNames"></datalist></div>
            <div class="f-group"><label>Ú¯Ù†Ø¯Ù… ÙˆØ²Ù† (Ú©Ù„Ùˆ)</label><input type="number" id="wWeight" step="0.01"></div>
            <div class="f-group"><label>Ø¢Ù¹Ø§ Ø±ÛŒÙ¹</label><input type="number" id="aRate" value="120"></div>
            <div class="f-group"><label>Ø§ÛŒÚˆÙˆØ§Ù†Ø³ Ø¢Ù¹Ø§</label><input type="number" id="advA" value="0"></div>
            <div class="checkboxes">
                <label><input type="checkbox" id="noCln"> ØµÙØ§Ø¦ÛŒ Ù†ÛÛŒÚº Ú©Ø±Ù†ÛŒ</label>
                <label><input type="checkbox" id="noKat"> Ú©Ù¹ÙˆØªÛŒ Ù†ÛÛŒÚº Ú©Ø±Ù†ÛŒ</label>
                <label><input type="checkbox" id="payByA"> Ø¨Ù„ Ø¢Ù¹Û’ Ø³Û’ Ú©Ø§Ù¹ÛŒÚº</label>
            </div>
            <button class="btn-calc" onclick="calculateBill()">Ø­Ø³Ø§Ø¨ Ú©Ø±ÛŒÚº (Ø±Ø³ÛŒØ¯ Ø¯ÛŒÚ©Ú¾ÛŒÚº)</button>
        </div>

        <div id="resPanel">
            <h3 style="text-align:center; margin-top:0; color:var(--accent);">Ø¹Ø§Ø±Ø¶ÛŒ Ø±Ø³ÛŒØ¯</h3>
            <div class="res-row"><span>Ù¹ÙˆÙ¹Ù„ Ø¨Ù„:</span> <span id="outB" style="font-weight:bold;">0</span></div>
            <div class="res-row"><span>ØµØ§Ù Ø¢Ù¹Ø§:</span> <span id="outNet" style="color:#2ecc71;">0</span> Ú©Ù„Ùˆ</div>
            <div class="btn-group">
                <button class="btn-nqd" onclick="saveData('Paid')">Ù†Ù‚Ø¯ ÙˆØµÙˆÙ„ÛŒ (Confirm)</button>
                <button class="btn-udhaar" onclick="saveData('Khata')">Ø§Ø¯Ú¾Ø§Ø± Ú©Ú¾Ø§ØªÛ (Confirm)</button>
                <button style="background:#666; color:white; border:none; border-radius:5px;" onclick="document.getElementById('resPanel').style.display='none'">Ú©ÛŒÙ†Ø³Ù„</button>
            </div>
        </div>
    </div>

    <div class="tabs no-print">
        <div class="tab-btn active" onclick="switchTab(event, 'tabDaily')">Ø±ÙˆØ²Ù…Ø±Û Ø±ÛŒÚ©Ø§Ø±Úˆ</div>
        <div class="tab-btn" onclick="switchTab(event, 'tabKhata')">Ú©Ú¾Ø§ØªÛ (Ø§Ø¯Ú¾Ø§Ø±)</div>
        <div class="tab-btn" onclick="switchTab(event, 'tabStats')">Ù…Ø¬Ù…ÙˆØ¹ÛŒ Ø±Ù¾ÙˆØ±Ù¹</div>
    </div>

    <div id="tabDaily" class="tab-content active">
        <div class="no-print" style="margin-bottom:10px;">
            <label>ÙÙ„Ù¹Ø± ØªØ§Ø±ÛŒØ®:</label> <input type="date" id="filterDate" onchange="renderDaily()" style="padding:5px;">
        </div>
        <table id="dailyTbl">
            <thead><tr><th>ØªØ§Ø±ÛŒØ®</th><th>Ù†Ø§Ù…</th><th>ÙˆØ²Ù†</th><th>Ø¨Ù„</th><th>Ø­Ø§Ù„Øª</th><th>Ø­Ø°Ù</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="tabKhata" class="tab-content">
        <table id="khataTbl">
            <thead><tr><th>Ù†Ø§Ù…</th><th>Ú©Ù„ Ø§Ø¯Ú¾Ø§Ø±</th><th>Ø¨Ù‚Ø§ÛŒØ§</th><th>Ø§Ø¹Ù…Ø§Ù„</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="tabStats" class="tab-content">
        <div class="stats-grid">
            <div class="stat-card"><h4>Ú©Ù„ Ú¯Ù†Ø¯Ù…</h4><p id="statW">0 Ú©Ù„Ùˆ</p></div>
            <div class="stat-card"><h4>Ù†Ù‚Ø¯ ÙˆØµÙˆÙ„ÛŒ</h4><p id="statC">0</p></div>
            <div class="stat-card"><h4>Ù…Ø§Ø±Ú©ÛŒÙ¹ Ø§Ø¯Ú¾Ø§Ø±</h4><p id="statP" style="color:red">0</p></div>
        </div>
        <button class="btn-action" style="width:100%; background:#c0392b" onclick="downloadPDF()">Ù…Ø¬Ù…ÙˆØ¹ÛŒ Ø±Ù¾ÙˆØ±Ù¹ PDF ÚˆØ§Ø¤Ù† Ù„ÙˆÚˆ Ú©Ø±ÛŒÚº</button>
    </div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('chaki_v11_final')) || [];
    let tempEntry = null;

    function initApp() {
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
        renderDaily();
        updateCustomerList();
    }

    function calculateBill() {
        const name = document.getElementById('cName').value.trim();
        const weight = parseFloat(document.getElementById('wWeight').value) || 0;
        const rate = parseFloat(document.getElementById('aRate').value) || 120;
        const adv = parseFloat(document.getElementById('advA').value) || 0;

        if (!name || weight <= 0) { alert("Ù†Ø§Ù… Ø§ÙˆØ± ÙˆØ²Ù† Ø¶Ø±ÙˆØ±ÛŒ ÛÛ’!"); return; }

        const fee = (weight * 3.00) + (document.getElementById('noCln').checked ? 0 : (weight * 1.20));
        const katW = weight * 0.050;
        const katC = document.getElementById('noKat').checked ? (katW * rate) : 0;
        let finalBill = fee + katC;
        let netFlour = weight - (document.getElementById('noKat').checked ? 0 : katW) - adv;

        if (document.getElementById('payByA').checked) { netFlour -= (finalBill / rate); finalBill = 0; }

        tempEntry = { id: Date.now(), name, weight, finalBill, paid: 0, balance: finalBill, date: new Date().toISOString().split('T')[0] };
        
        document.getElementById('outB').innerText = finalBill.toFixed(0) + " Ø±ÙˆÙ¾Û’";
        document.getElementById('outNet').innerText = netFlour.toFixed(2);
        document.getElementById('resPanel').style.display = 'block';
    }

    function saveData(status) {
        if (!confirm("Ú©ÛŒØ§ Ø¢Ù¾ ÛŒÛ Ø±ÛŒÚ©Ø§Ø±Úˆ Ù…Ø­ÙÙˆØ¸ Ú©Ø±Ù†Ø§ Ú†Ø§ÛØªÛ’ ÛÛŒÚºØŸ")) return;
        if (status === 'Paid') { tempEntry.paid = tempEntry.finalBill; tempEntry.balance = 0; }
        tempEntry.status = status;
        db.push(tempEntry);
        sync();
        document.getElementById('resPanel').style.display = 'none';
        document.getElementById('cName').value = '';
        document.getElementById('wWeight').value = '';
    }

    function sync() {
        localStorage.setItem('chaki_v11_final', JSON.stringify(db));
        renderDaily();
        renderKhata();
        renderStats();
        updateCustomerList();
    }

    function renderDaily() {
        const tbody = document.querySelector('#dailyTbl tbody');
        const filter = document.getElementById('filterDate').value;
        tbody.innerHTML = '';
        db.sort((a,b) => b.id - a.id).forEach(item => {
            if (filter && item.date !== filter) return;
            tbody.innerHTML += `<tr>
                <td>${item.date}</td><td>${item.name}</td><td>${item.weight}</td>
                <td>${item.finalBill.toFixed(0)}</td>
                <td><span style="color:${item.status==='Paid'?'green':'orange'}; font-weight:bold">${item.status==='Paid'?'Ù†Ù‚Ø¯':'Ø§Ø¯Ú¾Ø§Ø±'}</span></td>
                <td><button class="btn-del" onclick="deleteItem(${item.id})">Ã—</button></td>
            </tr>`;
        });
    }

    function renderKhata() {
        const tbody = document.querySelector('#khataTbl tbody');
        tbody.innerHTML = '';
        const summary = {};
        db.forEach(i => {
            if (!summary[i.name]) summary[i.name] = { total: 0, bal: 0 };
            summary[i.name].total += i.finalBill;
            summary[i.name].bal += i.balance;
        });

        for (let name in summary) {
            if (summary[name].bal <= 1) continue;
            tbody.innerHTML += `<tr>
                <td>${name}</td><td>${summary[name].total.toFixed(0)}</td>
                <td style="color:red; font-weight:bold">${summary[name].bal.toFixed(0)}</td>
                <td>
                    <button class="btn-action" onclick="receivePayment('${name}')">ÙˆØµÙˆÙ„ÛŒ</button>
                    <button class="btn-action" style="background:#27ae60" onclick="addNewWeight('${name}')">Ù†ÛŒØ§ ÙˆØ²Ù†</button>
                </td>
            </tr>`;
        }
    }

    function receivePayment(name) {
        let amt = prompt(`Ú¯Ø§ÛÚ© "${name}" Ø³Û’ ÙˆØµÙˆÙ„ÛŒ Ø±Ù‚Ù…:`);
        if (!amt || isNaN(amt)) return;
        amt = parseFloat(amt);
        if (!confirm(`${amt} Ø±ÙˆÙ¾Û’ Ú©ÛŒ ÙˆØµÙˆÙ„ÛŒ Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚºØŸ`)) return;

        let remaining = amt;
        db.filter(i => i.name === name && i.balance > 0).sort((a,b) => a.id - b.id).forEach(item => {
            if (remaining <= 0) return;
            let take = Math.min(remaining, item.balance);
            item.paid += take;
            item.balance -= take;
            if (item.balance <= 0) item.status = 'Paid';
            remaining -= take;
        });
        sync();
    }

    function addNewWeight(name) {
        document.getElementById('cName').value = name;
        window.scrollTo(0,0);
    }

    function deleteItem(id) {
        if (confirm("Ú©ÛŒØ§ Ø¢Ù¾ Ø­Ø°Ù Ú©Ø±Ù†Ø§ Ú†Ø§ÛØªÛ’ ÛÛŒÚºØŸ")) { db = db.filter(i => i.id !== id); sync(); }
    }

    function renderStats() {
        let tw = 0, tc = 0, tp = 0;
        db.forEach(i => { tw += i.weight; tc += i.paid; tp += i.balance; });
        document.getElementById('statW').innerText = tw.toFixed(1) + " Ú©Ù„Ùˆ";
        document.getElementById('statC').innerText = tc.toFixed(0);
        document.getElementById('statP').innerText = tp.toFixed(0);
    }

    function updateCustomerList() {
        const list = document.getElementById('custNames');
        const names = [...new Set(db.map(i => i.name))];
        list.innerHTML = names.map(n => `<option value="${n}">`).join('');
    }

    function switchTab(e, id) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        e.currentTarget.classList.add('active');
        if (id === 'tabKhata') renderKhata();
        if (id === 'tabStats') renderStats();
    }

    function exportData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
        const a = document.createElement('a');
        a.setAttribute("href", dataStr);
        a.setAttribute("download", "chaki_backup.json");
        a.click();
    }

    function importData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.onchange = e => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.readAsText(file);
            reader.onload = event => {
                db = JSON.parse(event.target.result);
                sync();
                alert("ÚˆÛŒÙ¹Ø§ Ù„ÙˆÚˆ ÛÙˆ Ú¯ÛŒØ§!");
            };
        };
        input.click();
    }

    function downloadPDF() {
        const element = document.querySelector('.container');
        html2pdf().from(element).save('Chaki_Report.pdf');
    }
</script>
</body>
            </html>
        
