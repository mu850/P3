<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>آٹا چکی اسمارٹ رجسٹر</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2e7d32">
    <style>
        :root { --primary: #2e7d32; --secondary: #1565c0; --danger: #d32f2f; --dark: #263238; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f4f7f6; padding: 10px; margin: 0; }
        .container { background: white; max-width: 900px; margin: auto; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); padding: 15px; }
        h2 { text-align: center; color: var(--primary); margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        /* Form Box */
        .form-box { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; background: #fff; padding: 15px; border-radius: 10px; border: 1px solid #ddd; }
        .f-group { display: flex; flex-direction: column; }
        label { font-weight: bold; margin-bottom: 5px; color: #444; }
        input { padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }

        .checkboxes { grid-column: span 2; display: flex; flex-wrap: wrap; gap: 15px; background: #e8f5e9; padding: 10px; border-radius: 8px; }
        .check-item { display: flex; align-items: center; cursor: pointer; font-size: 14px; font-weight: 500; }
        .check-item input { width: 18px; height: 18px; margin-left: 8px; }

        .btn-calc { grid-column: span 2; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; }

        /* Result Panel */
        #resPanel { background: var(--dark); color: white; padding: 20px; border-radius: 12px; margin-top: 15px; display: none; }
        .r-row { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 5px; }
        .highlight { color: #f1c40f; font-size: 22px; font-weight: bold; }

        .btn-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .btn-actions button { padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; }
        .btn-green { background: #27ae60; grid-column: span 2; font-size: 18px; }
        .btn-orange { background: #e67e22; }
        .btn-blue { background: #2980b9; }

        /* Tabs and Tables */
        .tab-bar { display: flex; margin-top: 30px; border-bottom: 2px solid #ddd; overflow-x: auto; }
        .tab-btn { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: bold; color: #666; white-space: nowrap; }
        .tab-btn.active { border-bottom: 4px solid var(--primary); color: var(--primary); }
        .tab-page { display: none; padding-top: 20px; }
        .tab-page.active { display: block; }

        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background: #37474f; color: white; }
        tr:nth-child(even) { background: #f9f9f9; }

        .summary-card { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .stat-item { text-align: center; border-left: 1px solid #eee; }
        .stat-item:last-child { border-left: none; }
        .stat-val { font-size: 18px; font-weight: bold; color: var(--primary); }

        .badge { padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .badge-khata { background: #ffebee; color: #c62828; }
        .badge-paid { background: #e8f5e9; color: #2e7d32; }

        @media (max-width: 600px) { .form-box { grid-template-columns: 1fr; } .summary-card { grid-template-columns: 1fr; } }
    </style>
</head>
<body onload="appInit()">

<div class="container">
    <h2>آٹا چکی ڈیجیٹل رجسٹر</h2>

    <div class="form-box">
        <div class="f-group"><label>گاہک کا نام</label><input type="text" id="custName" list="customerList" placeholder="نام لکھیں یا منتخب کریں">
            <datalist id="customerList"></datalist>
        </div>
        <div class="f-group"><label>گندم وزن (کلو)</label><input type="number" id="wtInput" placeholder="0.00"></div>
        <div class="f-group"><label>آٹا ریٹ (فی کلو)</label><input type="number" id="rateInput" value="110"></div>
        <div class="f-group"><label>ایڈوانس آٹا (کلو)</label><input type="number" id="advInput" value="0"></div>
        
        <div class="checkboxes">
            <label class="check-item"><input type="checkbox" id="checkSafai"><span>صفائی نہیں کرنی</span></label>
            <label class="check-item"><input type="checkbox" id="checkKatoti"><span>کٹوتی نہیں کرنی</span></label>
            <label class="check-item"><input type="checkbox" id="checkPayByFlour"><span>بل آٹے سے کاٹیں</span></label>
        </div>
        
        <button class="btn-calc" onclick="calculate()">حساب کریں</button>
    </div>

    <div id="resPanel">
        <div class="r-row"><span>پسائی و صفائی فیس:</span> <span id="outFees">0</span></div>
        <div class="r-row"><span class="highlight">ٹوٹل بل:</span> <span class="highlight" id="outBill">0</span></div>
        <div class="r-row" style="color:#2ecc71"><span>صاف آٹا (نیٹ):</span> <span id="outNet" style="font-size:20px; font-weight:bold;">0</span> کلو</div>
        
        <div class="btn-actions">
            <button class="btn-green" onclick="saveRecord('Paid')">نقد وصولی (تصدیق)</button>
            <button class="btn-blue" onclick="document.getElementById('resPanel').style.display='none'">ایڈٹ</button>
            <button class="btn-orange" onclick="saveRecord('Khata')">ادھار کھاتہ میں ڈالیں</button>
        </div>
    </div>

    <div class="tab-bar">
        <div class="tab-btn active" onclick="openPage(event, 'pageSum')">گاہکوں کا مجموعی کھاتہ</div>
        <div class="tab-btn" onclick="openPage(event, 'pageDaily')">روزمرہ سلپس</div>
        <div class="tab-btn" onclick="openPage(event, 'pageReports')">رپورٹ</div>
    </div>

    <div id="pageSum" class="tab-page active" style="overflow-x:auto;">
        <p style="font-size: 13px; color: #666;">* یہاں ہر گاہک کا ٹوٹل حساب ایک جگہ جمع ہو کر نظر آئے گا۔</p>
        <table id="tblSummary">
            <thead>
                <tr><th>گاہک کا نام</th><th>کل بل</th><th>کل وصولی</th><th>حتمی بقایا</th><th>اعمال</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="pageDaily" class="tab-page" style="overflow-x:auto;">
        <table id="tblDaily">
            <thead>
                <tr><th>تاریخ</th><th>نام</th><th>وزن</th><th>بل</th><th>حالت</th><th>اعمال</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="pageReports" class="tab-page">
        <div class="summary-card">
            <div class="stat-item"><h4>کل گندم</h4><p class="stat-val" id="statWheat">0 کلو</p></div>
            <div class="stat-item"><h4>کل نقد آمدن</h4><p class="stat-val" id="statCash">0 روپے</p></div>
            <div class="stat-item"><h4>مارکیٹ ادھار</h4><p class="stat-val" id="statCredit" style="color:var(--danger)">0 روپے</p></div>
        </div>
        
    </div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('atta_pro_v6')) || [];
    let tempEntry = null;

    function appInit() {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(e => console.log(e));
        }
        renderTables();
    }

    function calculate() {
        const name = document.getElementById('custName').value.trim();
        const weight = parseFloat(document.getElementById('wtInput').value);
        const rate = parseFloat(document.getElementById('rateInput').value);
        const adv = parseFloat(document.getElementById('advInput').value) || 0;

        if (!name || isNaN(weight)) { alert("نام اور وزن ضروری ہے!"); return; }

        const pisai = 3.00, safai = 1.20, katotiRate = 0.050;
        const noSafai = document.getElementById('checkSafai').checked;
        const noKatoti = document.getElementById('checkKatoti').checked;
        const payByFlour = document.getElementById('checkPayByFlour').checked;

        let fee = (weight * pisai) + (noSafai ? 0 : (weight * safai));
        let katotiWeight = weight * katotiRate;
        let katotiCost = noKatoti ? (katotiWeight * rate) : 0;
        let totalBill = fee + katotiCost;
        let netFlour = weight - (noKatoti ? 0 : katotiWeight) - adv;

        if (payByFlour) {
            netFlour -= (totalBill / rate);
            totalBill = 0;
        }

        tempEntry = {
            id: Date.now(),
            name, weight, totalBill, 
            paid: 0, balance: totalBill,
            netFlour, date: new Date().toLocaleDateString('en-GB')
        };

        document.getElementById('outFees').innerText = fee.toFixed(0);
        document.getElementById('outBill').innerText = totalBill.toFixed(0);
        document.getElementById('outNet').innerText = netFlour.toFixed(2);
        document.getElementById('resPanel').style.display = 'block';
    }

    function saveRecord(status) {
        if (!tempEntry) return;
        tempEntry.status = status;
        if (status === 'Paid') {
            tempEntry.paid = tempEntry.totalBill;
            tempEntry.balance = 0;
        }
        db.push(tempEntry);
        sync();
        resetForm();
    }

    function sync() {
        localStorage.setItem('atta_pro_v6', JSON.stringify(db));
        renderTables();
    }

    function renderTables() {
        const dailyBody = document.querySelector('#tblDaily tbody');
        const summaryBody = document.querySelector('#tblSummary tbody');
        const listData = document.getElementById('customerList');
        
        dailyBody.innerHTML = ''; summaryBody.innerHTML = ''; listData.innerHTML = '';

        let totals = { w: 0, cash: 0, cred: 0 };
        let customerMap = {}; // Aggregate data here

        db.sort((a,b) => b.id - a.id).forEach(item => {
            // Stats calculation
            totals.w += item.weight;
            totals.cash += item.paid;
            totals.cred += item.balance;

            // Daily Slips Table
            dailyBody.innerHTML += `<tr>
                <td>${item.date}</td><td>${item.name}</td><td>${item.weight}</td>
                <td>${item.totalBill.toFixed(0)}</td>
                <td><span class="badge ${item.status==='Paid'?'badge-paid':'badge-khata'}">${item.status==='Paid'?'نقد':'ادھار'}</span></td>
                <td><button onclick="delItem(${item.id})" style="color:red; border:none; background:none; cursor:pointer;">×</button></td>
            </tr>`;

            // Aggregate Data by Name (Customer Ledger)
            let n = item.name.toLowerCase().trim();
            if (!customerMap[n]) {
                customerMap[n] = { name: item.name, bill: 0, paid: 0, bal: 0 };
            }
            customerMap[n].bill += item.totalBill;
            customerMap[n].paid += item.paid;
            customerMap[n].bal += item.balance;
        });

        // Fill Customer Summary Table (Unified Record)
        Object.values(customerMap).forEach(c => {
            listData.innerHTML += `<option value="${c.name}">`;
            summaryBody.innerHTML += `<tr>
                <td style="font-weight:bold">${c.name}</td>
                <td>${c.bill.toFixed(0)}</td>
                <td>${c.paid.toFixed(0)}</td>
                <td style="color:${c.bal>0?'red':'green'}; font-weight:bold">${c.bal.toFixed(0)}</td>
                <td><button onclick="payKhata('${c.name}')" class="badge-paid" style="border:none; cursor:pointer; padding:5px;">وصولی درج کریں</button></td>
            </tr>`;
        });

        document.getElementById('statWheat').innerText = totals.w.toFixed(1) + " کلو";
        document.getElementById('statCash').innerText = totals.cash.toFixed(0) + " روپے";
        document.getElementById('statCredit').innerText = totals.cred.toFixed(0) + " روپے";
    }

    function payKhata(custName) {
        let amount = prompt(`گاہک "${custName}" سے کتنی رقم وصول ہوئی؟`);
        amount = parseFloat(amount);
        if (isNaN(amount) || amount <= 0) return;

        // Apply payment to oldest pending entries for this customer
        let remaining = amount;
        db.filter(i => i.name.toLowerCase().trim() === custName.toLowerCase().trim() && i.balance > 0)
          .sort((a,b) => a.id - b.id)
          .forEach(item => {
              if (remaining <= 0) return;
              let pay = Math.min(remaining, item.balance);
              item.paid += pay;
              item.balance -= pay;
              remaining -= pay;
              if (item.balance <= 0) item.status = 'Paid';
          });
        
        sync();
        alert("وصولی درج کر لی گئی۔");
    }

    function delItem(id) {
        if (confirm("کیا آپ یہ سلپ حذف کرنا چاہتے ہیں؟")) {
            db = db.filter(i => i.id !== id);
            sync();
        }
    }

    function resetForm() {
        document.getElementById('custName').value = '';
        document.getElementById('wtInput').value = '';
        document.getElementById('advInput').value = '0';
        document.getElementById('resPanel').style.display = 'none';
        tempEntry = null;
    }

    function openPage(evt, pageId) {
        document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        evt.currentTarget.classList.add('active');
    }
</script>

</body>
</html>
