<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>آٹا چکی ڈیجیٹل رجسٹر پرو</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --primary: #2e7d32; --dark: #263238; --accent: #f1c40f; --danger: #d32f2f; --blue: #1976d2; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f4f7f6; margin: 0; direction: rtl; padding: 10px; }
        .container { background: white; max-width: 950px; margin: auto; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); padding: 15px; }
        h2, h3 { text-align: center; color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        /* Inputs */
        .form-box { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; background: #fff; padding: 15px; border-radius: 10px; border: 1px solid #ddd; margin-bottom: 20px; }
        input { padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 15px; }
        .btn-calc { grid-column: 1 / -1; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .stat-card { background: var(--dark); color: white; padding: 15px; border-radius: 10px; text-align: center; border-bottom: 4px solid var(--accent); }
        .stat-card p { font-size: 18px; font-weight: bold; color: var(--accent); margin: 5px 0; }
        .stat-card span { font-size: 13px; color: #4caf50; display: block; margin-top: 5px; }

        /* Tabs */
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-top: 20px; background: #eee; overflow-x: auto; }
        .tab-btn { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: bold; color: #666; white-space: nowrap; }
        .tab-btn.active { border-bottom: 4px solid var(--primary); color: var(--primary); background: #fff; }
        .tab-content { display: none; padding-top: 15px; }
        .tab-content.active { display: block; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; font-size: 14px; }
        th { background: #37474f; color: white; }
        .btn-s { padding: 5px 10px; border-radius: 4px; border: none; cursor: pointer; color: white; margin: 2px; font-size: 12px; }
        
        #resPanel { background: var(--dark); color: white; padding: 15px; border-radius: 10px; margin-top: 15px; display: none; }
        .res-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #444; }
    </style>
</head>
<body onload="initApp()">

<div class="container">
    <h2>آٹا چکی اسمارٹ رجسٹر</h2>

    <div class="form-box">
        <h3 style="grid-column: 1/-1; margin:0; font-size:16px;">گندم پسائی انٹری</h3>
        <input type="text" id="cName" placeholder="گاہک کا نام">
        <input type="number" id="wWeight" placeholder="گندم وزن (کلو)">
        <input type="number" id="aRate" value="120" placeholder="آٹا ریٹ">
        <div style="grid-column: 1/-1; display:flex; gap:10px; flex-wrap:wrap; background:#f9f9f9; padding:10px; border-radius:8px;">
            <label><input type="checkbox" id="noCln"> صفائی نہیں</label>
            <label><input type="checkbox" id="noKat"> کٹوتی نہیں</label>
            <label><input type="checkbox" id="payByA"> بل بذریعہ آٹا</label>
        </div>
        <button class="btn-calc" onclick="calculateBill()">حساب کریں اور رسید دیکھیں</button>
    </div>

    <div id="resPanel">
        <div class="res-row"><span>ٹوٹل بل:</span> <span id="outB">0</span></div>
        <div class="res-row"><span>کٹوتی وزن:</span> <span id="outKatW">0</span> کلو</div>
        <div class="res-row"><span>صاف آٹا:</span> <span id="outNet">0</span> کلو</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
            <button onclick="saveData('Paid')" style="background:#27ae60; color:white; grid-column:span 2; padding:10px; border:none; border-radius:5px;">نقد وصولی (Confirm)</button>
            <button onclick="saveData('Khata')" style="background:#e67e22; color:white; padding:10px; border:none; border-radius:5px;">ادھار کھاتہ (Confirm)</button>
        </div>
    </div>

    <hr>

    <div class="form-box" style="border-color: var(--blue);">
        <h3 style="grid-column: 1/-1; margin:0; font-size:16px; color:var(--blue);">اکٹھا آٹا فروخت (کھاتہ)</h3>
        <input type="text" id="saleName" placeholder="خریدار کا نام">
        <input type="number" id="saleWeight" placeholder="آٹا وزن (کلو)">
        <input type="number" id="saleRate" value="120" placeholder="قیمت فی کلو">
        <button class="btn-calc" style="background:var(--blue);" onclick="saveFlourSale()">فروخت کا ریکارڈ سیو کریں</button>
    </div>

    <div class="tabs">
        <div class="tab-btn active" onclick="switchTab(event, 'tabDaily')">پسائی ریکارڈ</div>
        <div class="tab-btn" onclick="switchTab(event, 'tabSale')">آٹا فروخت</div>
        <div class="tab-btn" onclick="switchTab(event, 'tabStats')">مجموعی رپورٹ</div>
    </div>

    <div id="tabDaily" class="tab-content active">
        <table id="dailyTbl">
            <thead><tr><th>تاریخ/وقت</th><th>نام</th><th>وزن</th><th>بل</th><th>حالت</th><th>حذف</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="tabSale" class="tab-content">
        <table id="saleTbl">
            <thead><tr><th>تاریخ/وقت</th><th>خریدار</th><th>وزن</th><th>ٹوٹل بل</th><th>حالت</th><th>اعمال</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="tabStats" class="tab-content">
        <div class="stats-grid">
            <div class="stat-card">
                <h4>کل گندم (پسائی)</h4>
                <p id="statW">0 کلو</p>
                <span id="statWMan">0 من</span>
            </div>
            <div class="stat-card">
                <h4>کل آٹا فروخت</h4>
                <p id="statSW">0 کلو</p>
                <span id="statSWMan">0 من</span>
            </div>
            <div class="stat-card"><h4>کل نقد وصولی</h4><p id="statC">0</p></div>
            <div class="stat-card"><h4>ٹوٹل مارکیٹ ادھار</h4><p id="statP" style="color:red">0</p></div>
        </div>
    </div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('chaki_v14')) || [];
    let saleDb = JSON.parse(localStorage.getItem('chaki_sales_v14')) || [];
    let tempEntry = null;

    function initApp() { renderAll(); }

    function calculateBill() {
        const name = document.getElementById('cName').value.trim();
        const weight = parseFloat(document.getElementById('wWeight').value) || 0;
        const rate = parseFloat(document.getElementById('aRate').value) || 120;
        if (!name || weight <= 0) return alert("نام اور وزن لکھیں");

        const katW = document.getElementById('noKat').checked ? 0 : (weight * 0.050);
        const bill = (weight * 4.2); // پسائی + صفائی ریٹ ملا کر
        
        tempEntry = {
            id: Date.now(), name, weight, finalBill: bill,
            katW: katW, paid: 0, balance: bill,
            date: new Date().toLocaleString('ur-PK'), status: 'Khata'
        };

        document.getElementById('outB').innerText = bill.toFixed(0);
        document.getElementById('outKatW').innerText = katW.toFixed(2);
        document.getElementById('resPanel').style.display = 'block';
    }

    function saveData(status) {
        if (!confirm("کیا آپ سیو کرنا چاہتے ہیں؟")) return;
        if (status === 'Paid') { tempEntry.paid = tempEntry.finalBill; tempEntry.balance = 0; tempEntry.status = 'Paid'; }
        db.push(tempEntry);
        localStorage.setItem('chaki_v14', JSON.stringify(db));
        document.getElementById('resPanel').style.display = 'none';
        renderAll();
    }

    function saveFlourSale() {
        const name = document.getElementById('saleName').value.trim();
        const weight = parseFloat(document.getElementById('saleWeight').value) || 0;
        const rate = parseFloat(document.getElementById('saleRate').value) || 120;
        if (!name || weight <= 0) return alert("معلومات مکمل کریں");

        if(!confirm("آٹا فروخت کا ریکارڈ ادھار کھاتے میں سیو کریں؟")) return;

        const saleEntry = {
            id: Date.now(), name, weight, totalBill: (weight * rate),
            paid: 0, balance: (weight * rate), date: new Date().toLocaleString('ur-PK'), status: 'Khata'
        };
        saleDb.push(saleEntry);
        localStorage.setItem('chaki_sales_v14', JSON.stringify(saleDb));
        renderAll();
    }

    function renderAll() {
        // Daily Pisai
        const dBody = document.querySelector('#dailyTbl tbody');
        dBody.innerHTML = '';
        db.sort((a,b)=>b.id-a.id).forEach(i => {
            dBody.innerHTML += `<tr><td>${i.date}</td><td>${i.name}</td><td>${i.weight}</td><td>${i.finalBill.toFixed(0)}</td><td style="color:${i.status==='Paid'?'green':'orange'}">${i.status==='Paid'?'نقد':'ادھار'}</td><td><button class="btn-s" style="background:red" onclick="delP(${i.id})">×</button></td></tr>`;
        });

        // Flour Sales
        const sBody = document.querySelector('#saleTbl tbody');
        sBody.innerHTML = '';
        saleDb.sort((a,b)=>b.id-a.id).forEach(i => {
            sBody.innerHTML += `<tr><td>${i.date}</td><td>${i.name}</td><td>${i.weight}</td><td>${i.totalBill.toFixed(0)}</td><td style="color:red">${i.balance.toFixed(0)} بقایا</td><td><button class="btn-s" style="background:green" onclick="paySale(${i.id})">وصول</button><button class="btn-s" style="background:red" onclick="delS(${i.id})">×</button></td></tr>`;
        });

        calculateStats();
    }

    function calculateStats() {
        let tw = 0, sw = 0, tc = 0, tp = 0;
        db.forEach(i => { tw += i.weight; tc += i.paid; tp += i.balance; });
        saleDb.forEach(i => { sw += i.weight; tc += i.paid; tp += i.balance; });

        document.getElementById('statW').innerText = tw.toFixed(1) + " کلو";
        document.getElementById('statWMan').innerText = (tw / 40).toFixed(2) + " من";
        
        document.getElementById('statSW').innerText = sw.toFixed(1) + " کلو";
        document.getElementById('statSWMan').innerText = (sw / 40).toFixed(2) + " من";

        document.getElementById('statC').innerText = tc.toFixed(0);
        document.getElementById('statP').innerText = tp.toFixed(0);
    }

    function paySale(id) {
        let amt = prompt("وصول کی گئی رقم لکھیں:");
        if(!amt) return;
        saleDb.forEach(i => { if(i.id === id) { i.paid += parseFloat(amt); i.balance -= parseFloat(amt); } });
        localStorage.setItem('chaki_sales_v14', JSON.stringify(saleDb));
        renderAll();
    }

    function delP(id) { if(confirm("حذف کریں؟")) { db = db.filter(i=>i.id!==id); localStorage.setItem('chaki_v14', JSON.stringify(db)); renderAll(); } }
    function delS(id) { if(confirm("حذف کریں؟")) { saleDb = saleDb.filter(i=>i.id!==id); localStorage.setItem('chaki_sales_v14', JSON.stringify(saleDb)); renderAll(); } }

    function switchTab(e, id) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        e.currentTarget.classList.add('active');
    }
</script>
</body>
</html>
