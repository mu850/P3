<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¢Ù¹Ø§ Ú†Ú©ÛŒ Ø±Ø¬Ø³Ù¹Ø± Ù¾Ø±Ùˆ v17</title>
    <style>
        :root { --primary: #2e7d32; --dark: #263238; --accent: #f1c40f; --danger: #d32f2f; --blue: #1565c0; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f4f7; padding: 10px; margin: 0; direction: rtl; }
        .container { background: white; max-width: 900px; margin: auto; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); padding: 15px; }
        h2, h3 { text-align: center; color: var(--primary); margin-bottom: 10px; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        
        .form-box { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 20px; }
        .f-group { display: flex; flex-direction: column; }
        label { font-size: 13px; font-weight: bold; margin-bottom: 5px; }
        input { padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; }
        .btn-main { grid-column: 1 / -1; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: var(--dark); color: white; padding: 12px; border-radius: 8px; text-align: center; border-bottom: 4px solid var(--accent); }
        .stat-card p { font-size: 18px; font-weight: bold; color: var(--accent); margin: 5px 0; }

        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 10px; background: #eee; }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: bold; color: #666; }
        .tab.active { border-bottom: 4px solid var(--primary); color: var(--primary); background: #fff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        table { width: 100%; border-collapse: collapse; margin-top: 5px; background: white; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; font-size: 13px; }
        th { background: #37474f; color: white; }
        
        #receipt { background: #fff9c4; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 2px dashed var(--primary); display: none; }
        .res-line { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px solid #ddd; padding-bottom: 4px; }
    </style>
</head>
<body onload="init()">

<div class="container">
    <h2>Ø¢Ù¹Ø§ Ú†Ú©ÛŒ ÚˆÛŒØ¬ÛŒÙ¹Ù„ Ø±Ø¬Ø³Ù¹Ø±</h2>

    <div style="background:#e8f5e9; padding:10px; border-radius:8px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
        <small>ÚˆÛŒÙ¹Ø§ Ù…Ø­ÙÙˆØ¸ Ú©Ø±ÛŒÚº:</small>
        <div>
            <button onclick="exportData()" style="background:var(--blue); color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">ğŸ“¤ Ø¨ÛŒÚ© Ø§Ù¾</button>
            <button onclick="importData()" style="background:#5d4037; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">ğŸ“¥ Ø±ÛŒ Ø§Ø³Ù¹ÙˆØ±</button>
        </div>
    </div>

    <div class="form-box">
        <h3 style="grid-column: 1/-1; border:none; color:var(--primary); margin:0;">Ù†Ø¦ÛŒ Ù¾Ø³Ø§Ø¦ÛŒ Ø§Ù†Ù¹Ø±ÛŒ</h3>
        <div class="f-group"><label>Ú¯Ø§ÛÚ© Ú©Ø§ Ù†Ø§Ù…</label><input type="text" id="cName"></div>
        <div class="f-group"><label>Ú¯Ù†Ø¯Ù… ÙˆØ²Ù† (Ú©Ù„Ùˆ)</label><input type="number" id="wWeight"></div>
        <div class="f-group"><label>Ø¢Ù¹Ø§ Ø±ÛŒÙ¹</label><input type="number" id="aRate" value="120"></div>
        
        <div style="grid-column: 1/-1; display:flex; gap:15px; font-size:12px; background:#f9f9f9; padding:10px; border-radius:5px;">
            <label><input type="checkbox" id="noCln"> ØµÙØ§Ø¦ÛŒ Ù†ÛÛŒÚº Ú©Ø±Ù†ÛŒ</label>
            <label><input type="checkbox" id="noKat"> Ú©Ù¹ÙˆØªÛŒ Ù†ÛÛŒÚº Ú©Ø±Ù†ÛŒ (Ø¢Ù¹Ø§ Ù¾ÛŒØ³Û’ Ø¯ÛŒÚº)</label>
            <label><input type="checkbox" id="payByA"> Ø¨Ù„ Ø¢Ù¹Û’ Ø³Û’ Ú©Ø§Ù¹ÛŒÚº</label>
        </div>
        <button class="btn-main" onclick="calculate()">Ø­Ø³Ø§Ø¨ Ú©Ø±ÛŒÚº</button>
    </div>

    <div id="receipt">
        <h4 style="text-align:center; margin:0 0 10px 0;">Ø­Ø³Ø§Ø¨ Ú©ÛŒ ØªÙØµÛŒÙ„</h4>
        <div class="res-line"><span>Ù¾Ø³Ø§Ø¦ÛŒ Ø¨Ù„:</span> <span id="rPisai">0</span></div>
        <div class="res-line"><span>Ú©Ù¹ÙˆØªÛŒ Ø¢Ù¹Û’ Ú©ÛŒ Ù‚ÛŒÙ…Øª:</span> <span id="rKatPrice">0</span></div>
        <div class="res-line" style="font-weight:bold; color:var(--danger);"><span>Ù¹ÙˆÙ¹Ù„ Ù†Ù‚Ø¯ Ø¨Ù„:</span> <span id="rTotal">0</span></div>
        <div class="res-line" style="font-weight:bold; color:var(--primary);"><span>ØµØ§Ù Ø¢Ù¹Ø§ (ÙˆØ§Ù¾Ø³ÛŒ):</span> <span id="rNet">0</span> Ú©Ù„Ùˆ</div>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
            <button onclick="save('Paid')" style="background:var(--primary); color:white; padding:10px; border:none; border-radius:5px; font-weight:bold;">Ù†Ù‚Ø¯ ÙˆØµÙˆÙ„ÛŒ</button>
            <button onclick="save('Credit')" style="background:var(--danger); color:white; padding:10px; border:none; border-radius:5px; font-weight:bold;">Ø§Ø¯Ú¾Ø§Ø± Ú©Ú¾Ø§ØªÛ</button>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="openTab(event, 'tab1')">Ø±ÙˆØ²Ù…Ø±Û</div>
        <div class="tab" onclick="openTab(event, 'tab2')">Ø§Ø¯Ú¾Ø§Ø± Ú©Ú¾Ø§ØªÛ</div>
        <div class="tab" onclick="openTab(event, 'tab3')">Ø±Ù¾ÙˆØ±Ù¹</div>
    </div>

    <div id="tab1" class="tab-content active">
        <table id="dailyTbl">
            <thead><tr><th>Ù†Ø§Ù…</th><th>ÙˆØ²Ù†</th><th>Ø¨Ù„</th><th>Ø­Ø§Ù„Øª</th><th>Ø­Ø°Ù</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="tab2" class="tab-content">
        <table id="khataTbl">
            <thead><tr><th>Ù†Ø§Ù…</th><th>Ø¨Ù‚Ø§ÛŒØ§ Ø§Ø¯Ú¾Ø§Ø±</th><th>Ø§ÛŒÚ©Ø´Ù†</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="tab3" class="tab-content">
        <div class="stats-grid">
            <div class="stat-card"><h4>Ú©Ù„ Ú¯Ù†Ø¯Ù…</h4><p id="sW">0</p><span id="sM" style="font-size:12px; color:#aaa;">0 Ù…Ù†</span></div>
            <div class="stat-card"><h4>Ú©Ù„ Ú©Ù¹ÙˆØªÛŒ</h4><p id="sK" style="color:#2ecc71">0</p></div>
            <div class="stat-card"><h4>Ù†Ù‚Ø¯ Ø¢Ù…Ø¯Ù†</h4><p id="sC">0</p></div>
            <div class="stat-card"><h4>Ø¨Ù‚Ø§ÛŒØ§ Ø§Ø¯Ú¾Ø§Ø±</h4><p id="sP" style="color:red">0</p></div>
        </div>
    </div>

    <br><hr>
    <div class="form-box" style="border: 2px solid var(--blue); margin-top:20px;">
        <h3 style="grid-column:1/-1; border:none; color:var(--blue); margin:0;">Ø¢Ù¹Ø§ Ø§Ø¯Ú¾Ø§Ø± Ø±Ø¬Ø³Ù¹Ø± (ÙØ±ÙˆØ®Øª)</h3>
        <input type="text" id="saleName" placeholder="Ø®Ø±ÛŒØ¯Ø§Ø± Ú©Ø§ Ù†Ø§Ù…">
        <input type="number" id="saleWeight" placeholder="Ø¢Ù¹Ø§ ÙˆØ²Ù† (Ú©Ù„Ùˆ)">
        <input type="number" id="saleRate" value="130">
        <button class="btn-main" style="background:var(--blue);" onclick="saveFlourSale()">ÙØ±ÙˆØ®Øª Ø³ÛŒÙˆ Ú©Ø±ÛŒÚº</button>
    </div>
    <table id="saleTbl">
        <thead><tr style="background:var(--blue); color:white;"><th>ØªØ§Ø±ÛŒØ®</th><th>Ù†Ø§Ù…</th><th>ÙˆØ²Ù†</th><th>Ø¨Ù‚Ø§ÛŒØ§</th><th>Ø§ÛŒÚ©Ø´Ù†</th></tr></thead>
        <tbody></tbody>
    </table>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('CHAKI_DB_V17')) || [];
    let sales = JSON.parse(localStorage.getItem('SALES_DB_V17')) || [];
    let temp = null;

    function init() { render(); }

    function calculate() {
        const name = document.getElementById('cName').value;
        const weight = parseFloat(document.getElementById('wWeight').value);
        const rate = parseFloat(document.getElementById('aRate').value);
        if(!name || !weight) return alert("Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ú©Ù…Ù„ Ú©Ø±ÛŒÚº");

        // 1. Ù¾Ø³Ø§Ø¦ÛŒ + ØµÙØ§Ø¦ÛŒ Ú©Ø§ Ø­Ø³Ø§Ø¨
        let pisaiRate = 3.00;
        let cleaningRate = document.getElementById('noCln').checked ? 0 : 1.20;
        let basicBill = weight * (pisaiRate + cleaningRate);

        // 2. Ú©Ù¹ÙˆØªÛŒ Ú©Ø§ Ø­Ø³Ø§Ø¨ (5%)
        let katWeight = weight * 0.05;
        let katPrice = 0;
        let netFlour = weight;

        if (document.getElementById('noKat').checked) {
            // Ø§Ú¯Ø± Ú©Ù¹ÙˆØªÛŒ Ù†ÛÛŒÚº Ú©Ø±Ù†ÛŒØŒ ØªÙˆ Ø§Ø³ Ø¢Ù¹Û’ Ú©ÛŒ Ù‚ÛŒÙ…Øª Ø¨Ù„ Ù…ÛŒÚº Ø¬Ù…Ø¹ ÛÙˆÚ¯ÛŒ
            katPrice = katWeight * rate;
            netFlour = weight; // Ú¯Ø§ÛÚ© Ú©Ùˆ Ù¾ÙˆØ±Ø§ Ø¢Ù¹Ø§ Ù…Ù„Û’ Ú¯Ø§
        } else {
            // Ø§Ú¯Ø± Ú©Ù¹ÙˆØªÛŒ Ú©Ø±Ù†ÛŒ ÛÛ’ØŒ ØªÙˆ Ø¢Ù¹Ø§ Ú©Ù… ÛÙˆÚ¯Ø§
            netFlour = weight - katWeight;
        }

        let finalCashBill = basicBill + katPrice;

        // 3. Ø¨Ù„ Ø¨Ø°Ø±ÛŒØ¹Û Ø¢Ù¹Ø§
        if (document.getElementById('payByA').checked) {
            let flourForBill = finalCashBill / rate;
            netFlour -= flourForBill;
            finalCashBill = 0;
        }

        temp = { id: Date.now(), name, weight, bill: finalCashBill, kat: katWeight, paid: 0, bal: finalCashBill, date: new Date().toLocaleString('ur-PK') };
        
        document.getElementById('rPisai').innerText = basicBill.toFixed(0);
        document.getElementById('rKatPrice').innerText = katPrice.toFixed(0);
        document.getElementById('rTotal').innerText = finalCashBill.toFixed(0);
        document.getElementById('rNet').innerText = netFlour.toFixed(2);
        document.getElementById('receipt').style.display = 'block';
    }

    function save(status) {
        if(status === 'Paid') { temp.paid = temp.bill; temp.bal = 0; }
        db.push(temp);
        localStorage.setItem('CHAKI_DB_V17', JSON.stringify(db));
        document.getElementById('receipt').style.display = 'none';
        document.getElementById('cName').value = '';
        document.getElementById('wWeight').value = '';
        render();
    }

    function saveFlourSale() {
        const n = document.getElementById('saleName').value;
        const w = document.getElementById('saleWeight').value;
        const r = document.getElementById('saleRate').value;
        if(!n || !w) return alert("Ù†Ø§Ù… Ø§ÙˆØ± ÙˆØ²Ù† Ù„Ú©Ú¾ÛŒÚº");
        sales.push({ id: Date.now(), name: n, weight: w, bill: (w*r), paid: 0, bal: (w*r), date: new Date().toLocaleString('ur-PK') });
        localStorage.setItem('SALES_DB_V17', JSON.stringify(sales));
        render();
    }

    function render() {
        const dBody = document.querySelector('#dailyTbl tbody');
        dBody.innerHTML = '';
        db.slice().reverse().forEach(i => {
            dBody.innerHTML += `<tr><td>${i.name}</td><td>${i.weight}</td><td>${i.bill.toFixed(0)}</td><td style="color:${i.bal>0?'red':'green'}">${i.bal>0?'Ø§Ø¯Ú¾Ø§Ø±':'Ù†Ù‚Ø¯'}</td><td><button class="btn-del" onclick="del(${i.id},'p')">Ã—</button></td></tr>`;
        });

        const kBody = document.querySelector('#khataTbl tbody');
        kBody.innerHTML = '';
        let groups = {};
        db.forEach(i => { if(i.bal > 0) groups[i.name] = (groups[i.name] || 0) + i.bal; });
        for(let n in groups) {
            kBody.innerHTML += `<tr><td>${n}</td><td style="color:red">${groups[n].toFixed(0)}</td><td><button style="background:var(--blue); color:white; border:none; padding:4px; border-radius:4px;" onclick="payPisai('${n}')">ÙˆØµÙˆÙ„</button></td></tr>`;
        }

        const sBody = document.querySelector('#saleTbl tbody');
        sBody.innerHTML = '';
        sales.slice().reverse().forEach(i => {
            sBody.innerHTML += `<tr><td>${i.date.split(',')[0]}</td><td>${i.name}</td><td>${i.weight}</td><td style="color:red">${i.bal.toFixed(0)}</td><td><button style="background:var(--blue); color:white; border:none; padding:4px; border-radius:4px;" onclick="paySale(${i.id})">ÙˆØµÙˆÙ„</button></td></tr>`;
        });

        updateStats();
    }

    function payPisai(name) {
        let amt = parseFloat(prompt(`${name} Ø³Û’ Ø±Ù‚Ù… ÙˆØµÙˆÙ„ Ú©Ø±ÛŒÚº:`));
        if(!amt) return;
        db.filter(i => i.name === name && i.bal > 0).forEach(i => {
            let take = Math.min(amt, i.bal);
            i.paid += take; i.bal -= take; amt -= take;
        });
        localStorage.setItem('CHAKI_DB_V17', JSON.stringify(db));
        render();
    }

    function paySale(id) {
        let amt = parseFloat(prompt("Ø±Ù‚Ù… ÙˆØµÙˆÙ„ Ú©Ø±ÛŒÚº:"));
        if(!amt) return;
        sales.forEach(i => { if(i.id === id) { i.paid += amt; i.bal -= amt; } });
        localStorage.setItem('SALES_DB_V17', JSON.stringify(sales));
        render();
    }

    function del(id, type) {
        if(!confirm("ÚˆÛŒÙ„ÛŒÙ¹ Ú©Ø±ÛŒÚºØŸ")) return;
        if(type === 'p') db = db.filter(i => i.id !== id);
        else sales = sales.filter(i => i.id !== id);
        localStorage.setItem('CHAKI_DB_V17', JSON.stringify(db));
        localStorage.setItem('SALES_DB_V17', JSON.stringify(sales));
        render();
    }

    function updateStats() {
        let w = 0, c = 0, p = 0, k = 0;
        db.forEach(i => { w += i.weight; c += i.paid; p += i.bal; k += i.kat; });
        sales.forEach(i => { c += i.paid; p += i.bal; });
        document.getElementById('sW').innerText = w.toFixed(0) + " Ú©Ù„Ùˆ";
        document.getElementById('sM').innerText = (w/40).toFixed(2) + " Ù…Ù†";
        document.getElementById('sK').innerText = k.toFixed(2) + " Ú©Ù„Ùˆ";
        document.getElementById('sC').innerText = c.toFixed(0);
        document.getElementById('sP').innerText = p.toFixed(0);
    }

    function openTab(e, id) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        e.currentTarget.classList.add('active');
    }

    function exportData() {
        const data = { db, sales };
        const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `chaki_backup_${new Date().toLocaleDateString()}.json`;
        a.click();
    }

    function importData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.onchange = e => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = event => {
                const data = JSON.parse(event.target.result);
                db = data.db; sales = data.sales;
                localStorage.setItem('CHAKI_DB_V17', JSON.stringify(db));
                localStorage.setItem('SALES_DB_V17', JSON.stringify(sales));
                location.reload();
            };
            reader.readAsText(file);
        };
        input.click();
    }
</script>
</body>
</html>
