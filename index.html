<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¢Ù¹Ø§ Ú†Ú©ÛŒ Ø±Ø¬Ø³Ù¹Ø± Ù¾Ø±Ùˆ v18</title>
    <style>
        :root { --primary: #2e7d32; --dark: #263238; --accent: #f1c40f; --danger: #d32f2f; --blue: #1565c0; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f4f7; padding: 10px; margin: 0; direction: rtl; }
        .container { background: white; max-width: 900px; margin: auto; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); padding: 15px; }
        h2, h3 { text-align: center; color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 5px; }
        
        .form-box { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 20px; }
        input { padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; }
        .btn-main { grid-column: 1 / -1; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: var(--dark); color: white; padding: 12px; border-radius: 8px; text-align: center; border-bottom: 4px solid var(--accent); }
        .stat-card p { font-size: 18px; font-weight: bold; color: var(--accent); margin: 5px 0; }

        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 10px; background: #eee; }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: bold; color: #666; }
        .tab.active { border-bottom: 4px solid var(--primary); color: var(--primary); background: #fff; }
        .tab-content { display: none; padding-top: 10px; }
        .tab-content.active { display: block; }

        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; font-size: 13px; }
        th { background: #37474f; color: white; }
        .btn-s { padding: 5px 8px; border-radius: 4px; border: none; cursor: pointer; font-size: 11px; color: white; margin: 2px; }
        
        #receipt { background: #fff9c4; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 2px dashed var(--primary); display: none; }
        .res-line { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px solid #ddd; }
    </style>
</head>
<body onload="init()">

<div class="container">
    <h2>Ø¢Ù¹Ø§ Ú†Ú©ÛŒ ÚˆÛŒØ¬ÛŒÙ¹Ù„ Ø±Ø¬Ø³Ù¹Ø±</h2>

    <div style="background:#e8f5e9; padding:10px; border-radius:8px; margin-bottom:15px; display:flex; justify-content:space-between;">
        <button onclick="exportData()" style="background:var(--blue); color:white; border:none; padding:5px 10px; border-radius:4px;">ğŸ“¤ Ø¨ÛŒÚ© Ø§Ù¾</button>
        <button onclick="importData()" style="background:#5d4037; color:white; border:none; padding:5px 10px; border-radius:4px;">ğŸ“¥ Ø±ÛŒ Ø§Ø³Ù¹ÙˆØ±</button>
    </div>

    <div class="form-box" id="mainForm">
        <h3 style="grid-column: 1/-1; margin:0; font-size:16px;">Ú¯Ù†Ø¯Ù… Ù¾Ø³Ø§Ø¦ÛŒ Ø§Ù†Ù¹Ø±ÛŒ</h3>
        <input type="text" id="cName" placeholder="Ú¯Ø§ÛÚ© Ú©Ø§ Ù†Ø§Ù…">
        <input type="number" id="wWeight" placeholder="Ú¯Ù†Ø¯Ù… ÙˆØ²Ù† (Ú©Ù„Ùˆ)">
        <input type="number" id="aRate" value="120" placeholder="Ø¢Ù¹Ø§ Ø±ÛŒÙ¹">
        <div style="grid-column: 1/-1; display:flex; gap:10px; font-size:12px;">
            <label><input type="checkbox" id="noCln"> ØµÙØ§Ø¦ÛŒ Ù†ÛÛŒÚº</label>
            <label><input type="checkbox" id="noKat"> Ú©Ù¹ÙˆØªÛŒ Ù†ÛÛŒÚº</label>
            <label><input type="checkbox" id="payByA"> Ø¨Ù„ Ø¨Ø°Ø±ÛŒØ¹Û Ø¢Ù¹Ø§</label>
        </div>
        <button class="btn-main" onclick="calculate()">Ø­Ø³Ø§Ø¨ Ú©Ø±ÛŒÚº</button>
    </div>

    <div id="receipt">
        <div class="res-line"><span>Ù¹ÙˆÙ¹Ù„ Ù†Ù‚Ø¯ Ø¨Ù„:</span> <span id="rTotal" style="font-weight:bold; color:red;">0</span></div>
        <div class="res-line"><span>ØµØ§Ù Ø¢Ù¹Ø§ ÙˆØ§Ù¾Ø³ÛŒ:</span> <span id="rNet" style="font-weight:bold; color:green;">0</span> Ú©Ù„Ùˆ</div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
            <button onclick="save('Paid')" style="background:var(--primary); color:white; padding:10px; border:none; border-radius:5px;">Ù†Ù‚Ø¯ ÙˆØµÙˆÙ„ÛŒ</button>
            <button onclick="save('Credit')" style="background:var(--danger); color:white; padding:10px; border:none; border-radius:5px;">Ø§Ø¯Ú¾Ø§Ø± Ú©Ú¾Ø§ØªÛ</button>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="openTab(event, 'tabDaily')">Ø±ÙˆØ²Ù…Ø±Û</div>
        <div class="tab" onclick="openTab(event, 'tabKhata')">Ø§Ø¯Ú¾Ø§Ø± Ú©Ú¾Ø§ØªÛ</div>
        <div class="tab" onclick="openTab(event, 'tabStats')">Ù…Ø¬Ù…ÙˆØ¹ÛŒ Ø±ÛŒÚ©Ø§Ø±Úˆ</div>
    </div>

    <div id="tabDaily" class="tab-content active">
        <table>
            <thead><tr><th>ØªØ§Ø±ÛŒØ®</th><th>Ù†Ø§Ù…</th><th>ÙˆØ²Ù†</th><th>Ø¨Ù„</th><th>Ø­Ø§Ù„Øª</th></tr></thead>
            <tbody id="dailyBody"></tbody>
        </table>
    </div>

    <div id="tabKhata" class="tab-content">
        <table>
            <thead><tr><th>Ù†Ø§Ù… Ú¯Ø§ÛÚ©</th><th>Ú©Ù„ Ø¨Ù‚Ø§ÛŒØ§</th><th>Ø§Ø¹Ù…Ø§Ù„</th></tr></thead>
            <tbody id="khataBody"></tbody>
        </table>
    </div>

    <div id="tabStats" class="tab-content">
        <div class="stats-grid">
            <div class="stat-card"><h4>Ú©Ù„ Ú¯Ù†Ø¯Ù…</h4><p id="sW">0</p><span id="sM">0 Ù…Ù†</span></div>
            <div class="stat-card"><h4>Ù†Ù‚Ø¯ Ø¢Ù…Ø¯Ù†</h4><p id="sC">0</p></div>
            <div class="stat-card"><h4>Ù¹ÙˆÙ¹Ù„ Ø§Ø¯Ú¾Ø§Ø±</h4><p id="sP" style="color:red">0</p></div>
        </div>
        <h3 style="font-size:14px; color:var(--blue);">ØªÙ…Ø§Ù… Ù¹Ø±Ø§Ù†Ø²ÛŒÚ©Ø´Ù†Ø² Ú©Ø§ Ø±ÛŒÚ©Ø§Ø±Úˆ</h3>
        <div style="overflow-x:auto;">
            <table>
                <thead><tr style="background:#eee; color:#333;"><th>ØªØ§Ø±ÛŒØ®/ÙˆÙ‚Øª</th><th>Ù†Ø§Ù…</th><th>ÙˆØ²Ù†</th><th>Ø±Ù‚Ù…</th><th>Ù†ÙˆØ¹ÛŒØª</th><th>Ø­Ø°Ù</th></tr></thead>
                <tbody id="allRecordsBody"></tbody>
            </table>
        </div>
    </div>

    <br><hr>
    <div class="form-box" style="border: 2px solid var(--blue); margin-top:20px;">
        <h3 style="grid-column:1/-1; margin:0; color:var(--blue); font-size:16px;">Ø¢Ù¹Ø§ ÙØ±ÙˆØ®Øª Ø±Ø¬Ø³Ù¹Ø±</h3>
        <input type="text" id="saleName" placeholder="Ø®Ø±ÛŒØ¯Ø§Ø± Ú©Ø§ Ù†Ø§Ù…">
        <input type="number" id="saleWeight" placeholder="Ø¢Ù¹Ø§ ÙˆØ²Ù† (Ú©Ù„Ùˆ)">
        <input type="number" id="saleRate" value="120">
        <button class="btn-main" style="background:var(--blue);" onclick="saveSale()">Ø¢Ù¹Ø§ ÙØ±ÙˆØ®Øª Ø³ÛŒÙˆ Ú©Ø±ÛŒÚº</button>
    </div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('CHAKI_MASTER_DB')) || [];
    let sales = JSON.parse(localStorage.getItem('CHAKI_SALES_DB')) || [];
    let temp = null;

    function init() { render(); }

    function calculate() {
        const name = document.getElementById('cName').value.trim();
        const weight = parseFloat(document.getElementById('wWeight').value);
        const rate = parseFloat(document.getElementById('aRate').value);
        if(!name || !weight) return alert("Ø¨Ø±Ø§Û Ú©Ø±Ù… Ù†Ø§Ù… Ø§ÙˆØ± ÙˆØ²Ù† Ù„Ú©Ú¾ÛŒÚº");

        let pRate = 3.00 + (document.getElementById('noCln').checked ? 0 : 1.20);
        let basicBill = weight * pRate;
        let katWeight = weight * 0.05;
        let katPrice = document.getElementById('noKat').checked ? (katWeight * rate) : 0;
        let finalBill = basicBill + katPrice;
        let netFlour = document.getElementById('noKat').checked ? weight : (weight - katWeight);

        if (document.getElementById('payByA').checked) {
            netFlour -= (finalBill / rate);
            finalBill = 0;
        }

        temp = { id: Date.now(), name, weight, bill: finalBill, paid: 0, bal: finalBill, date: new Date().toLocaleString('ur-PK'), type: 'pisai' };
        document.getElementById('rTotal').innerText = finalBill.toFixed(0);
        document.getElementById('rNet').innerText = netFlour.toFixed(2);
        document.getElementById('receipt').style.display = 'block';
    }

    function save(status) {
        if(status === 'Paid') { temp.paid = temp.bill; temp.bal = 0; }
        db.push(temp);
        localStorage.setItem('CHAKI_MASTER_DB', JSON.stringify(db));
        document.getElementById('receipt').style.display = 'none';
        document.getElementById('cName').value = '';
        document.getElementById('wWeight').value = '';
        render();
    }

    function saveSale() {
        const n = document.getElementById('saleName').value;
        const w = parseFloat(document.getElementById('saleWeight').value);
        const r = parseFloat(document.getElementById('saleRate').value);
        if(!n || !w) return alert("Ù†Ø§Ù… Ø§ÙˆØ± ÙˆØ²Ù† Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚº");
        sales.push({ id: Date.now(), name: n, weight: w, bill: (w*r), paid: 0, bal: (w*r), date: new Date().toLocaleString('ur-PK'), type: 'sale' });
        localStorage.setItem('CHAKI_SALES_DB', JSON.stringify(sales));
        document.getElementById('saleName').value = '';
        document.getElementById('saleWeight').value = '';
        render();
    }

    function render() {
        // Daily Pisai
        const dBody = document.getElementById('dailyBody');
        dBody.innerHTML = '';
        db.slice(-10).reverse().forEach(i => {
            dBody.innerHTML += `<tr><td>${i.date.split(',')[0]}</td><td>${i.name}</td><td>${i.weight}</td><td>${i.bill.toFixed(0)}</td><td style="color:${i.bal>0?'red':'green'}">${i.bal>0?'Ø§Ø¯Ú¾Ø§Ø±':'Ù†Ù‚Ø¯'}</td></tr>`;
        });

        // Khata with "New Weight" button
        const kBody = document.getElementById('khataBody');
        kBody.innerHTML = '';
        let groups = {};
        db.concat(sales).forEach(i => { if(i.bal > 0) groups[i.name] = (groups[i.name] || 0) + i.bal; });
        for(let n in groups) {
            kBody.innerHTML += `<tr>
                <td>${n}</td>
                <td style="color:red; font-weight:bold;">${groups[n].toFixed(0)}</td>
                <td>
                    <button class="btn-s" style="background:var(--blue);" onclick="payAll('${n}')">ÙˆØµÙˆÙ„ÛŒ</button>
                    <button class="btn-s" style="background:var(--primary);" onclick="newWeight('${n}')">Ù†ÛŒØ§ ÙˆØ²Ù†</button>
                </td>
            </tr>`;
        }

        // All Transactions in Report Tab
        const allBody = document.getElementById('allRecordsBody');
        allBody.innerHTML = '';
        const all = db.concat(sales).sort((a,b) => b.id - a.id);
        all.forEach(i => {
            allBody.innerHTML += `<tr>
                <td style="font-size:10px;">${i.date}</td>
                <td>${i.name}</td>
                <td>${i.weight}</td>
                <td>${i.bill.toFixed(0)}</td>
                <td style="color:${i.type==='pisai'?'green':'var(--blue)'}">${i.type==='pisai'?'Ù¾Ø³Ø§Ø¦ÛŒ':'ÙØ±ÙˆØ®Øª'}</td>
                <td><button class="btn-s" style="background:red;" onclick="del(${i.id}, '${i.type}')">Ã—</button></td>
            </tr>`;
        });

        updateStats();
    }

    function newWeight(name) {
        document.getElementById('cName').value = name;
        openTab(null, 'tabDaily');
        window.scrollTo(0,0);
        document.getElementById('wWeight').focus();
    }

    function payAll(name) {
        let amt = parseFloat(prompt(`${name} Ø³Û’ Ú©ØªÙ†ÛŒ Ø±Ù‚Ù… ÙˆØµÙˆÙ„ Ú©ÛŒØŸ`));
        if(!amt) return;
        [db, sales].forEach(list => {
            list.filter(i => i.name === name && i.bal > 0).forEach(i => {
                let take = Math.min(amt, i.bal);
                i.paid += take; i.bal -= take; amt -= take;
            });
        });
        localStorage.setItem('CHAKI_MASTER_DB', JSON.stringify(db));
        localStorage.setItem('CHAKI_SALES_DB', JSON.stringify(sales));
        render();
    }

    function del(id, type) {
        if(!confirm("ÚˆÛŒÙ„ÛŒÙ¹ Ú©Ø±ÛŒÚºØŸ")) return;
        if(type === 'pisai') db = db.filter(i => i.id !== id);
        else sales = sales.filter(i => i.id !== id);
        localStorage.setItem('CHAKI_MASTER_DB', JSON.stringify(db));
        localStorage.setItem('CHAKI_SALES_DB', JSON.stringify(sales));
        render();
    }

    function updateStats() {
        let w = 0, c = 0, p = 0;
        db.forEach(i => { w += i.weight; c += i.paid; p += i.bal; });
        sales.forEach(i => { c += i.paid; p += i.bal; });
        document.getElementById('sW').innerText = w.toFixed(1) + " Ú©Ù„Ùˆ";
        document.getElementById('sM').innerText = (w/40).toFixed(2) + " Ù…Ù†";
        document.getElementById('sC').innerText = c.toFixed(0);
        document.getElementById('sP').innerText = p.toFixed(0);
    }

    function openTab(e, id) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(e) e.currentTarget.classList.add('active');
        else document.querySelector(`.tab[onclick*="${id}"]`).classList.add('active');
    }

    function exportData() {
        const data = { db, sales };
        const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `chaki_backup_${new Date().toLocaleDateString()}.json`;
        a.click();
    }

    function importData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.onchange = e => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = event => {
                const data = JSON.parse(event.target.result);
                db = data.db; sales = data.sales;
                localStorage.setItem('CHAKI_MASTER_DB', JSON.stringify(db));
                localStorage.setItem('CHAKI_SALES_DB', JSON.stringify(sales));
                location.reload();
            };
            reader.readAsText(file);
        };
        input.click();
    }
</script>
</body>
</html>
