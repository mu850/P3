<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¢Ù¹Ø§ Ú†Ú©ÛŒ Ø±Ø¬Ø³Ù¹Ø± - PDF Ø±Ù¾ÙˆØ±Ù¹</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --primary: #2e7d32; --dark: #263238; --accent: #f1c40f; }
        body { font-family: 'Segoe UI', Tahoma, Arial, sans-serif; background: #f4f7f6; padding: 10px; margin: 0; direction: rtl; }
        .container { background: white; max-width: 950px; margin: auto; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); padding: 15px; }
        h2 { text-align: center; color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        /* Form & Inputs */
        .form-box { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; background: #fff; padding: 15px; border-radius: 10px; border: 1px solid #ddd; }
        .f-group { display: flex; flex-direction: column; }
        label { font-weight: bold; margin-bottom: 5px; color: #444; }
        input { padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }
        .checkboxes { grid-column: 1 / -1; display: flex; flex-wrap: wrap; gap: 15px; background: #e8f5e9; padding: 10px; border-radius: 8px; }
        .btn-calc { grid-column: 1 / -1; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; }

        /* Report Cards */
        .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .report-card { background: var(--dark); color: white; padding: 15px; border-radius: 10px; text-align: center; border-bottom: 4px solid var(--accent); }
        .report-card h4 { margin: 0; font-size: 13px; color: #bbb; }
        .report-card p { margin: 8px 0 0; font-size: 18px; font-weight: bold; color: var(--accent); }

        /* Buttons */
        .btn-pdf { background: #c0392b; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        
        /* Tables */
        .tab-bar { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: bold; color: #666; }
        .tab-btn.active { border-bottom: 4px solid var(--primary); color: var(--primary); }
        .tab-page { display: none; }
        .tab-page.active { display: block; }
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 5px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; font-size: 14px; }
        th { background: #37474f; color: white; }
        
        #resPanel { background: #222; color: white; padding: 15px; border-radius: 10px; margin-top: 15px; display: none; }

        /* PDF Layout optimization */
        #pdfContent { padding: 10px; }
    </style>
</head>
<body onload="appInit()">

<div class="container">
    <h2>Ø¢Ù¹Ø§ Ú†Ú©ÛŒ ÚˆÛŒØ¬ÛŒÙ¹Ù„ Ø±Ø¬Ø³Ù¹Ø±</h2>

    <div class="form-box">
        <div class="f-group"><label>Ú¯Ø§ÛÚ© Ú©Ø§ Ù†Ø§Ù…</label><input type="text" id="custName" list="customerList"><datalist id="customerList"></datalist></div>
        <div class="f-group"><label>Ú¯Ù†Ø¯Ù… ÙˆØ²Ù† (Ú©Ù„Ùˆ)</label><input type="number" id="wtInput" placeholder="0.00"></div>
        <div class="f-group"><label>Ø¢Ù¹Ø§ Ø±ÛŒÙ¹</label><input type="number" id="rateInput" value="110"></div>
        <div class="f-group"><label>Ø§ÛŒÚˆÙˆØ§Ù†Ø³ Ø¢Ù¹Ø§</label><input type="number" id="advInput" value="0"></div>
        <div class="checkboxes">
            <label><input type="checkbox" id="checkSafai"> ØµÙØ§Ø¦ÛŒ Ù†ÛÛŒÚº Ú©Ø±Ù†ÛŒ</label>
            <label><input type="checkbox" id="checkKatoti"> Ú©Ù¹ÙˆØªÛŒ Ù†ÛÛŒÚº Ú©Ø±Ù†ÛŒ</label>
            <label><input type="checkbox" id="checkPayByFlour"> Ø¨Ù„ Ø¢Ù¹Û’ Ø³Û’ Ú©Ø§Ù¹ÛŒÚº</label>
        </div>
        <button class="btn-calc" onclick="calculate()">Ø­Ø³Ø§Ø¨ Ú©Ø±ÛŒÚº</button>
    </div>

    <div id="resPanel">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;"><span>Ú©Ù„ Ø¨Ù„:</span> <span id="outBill" style="color:var(--accent); font-size:20px; font-weight:bold;">0</span></div>
        <div style="display:flex; justify-content:space-between;"><span>ØµØ§Ù Ø¢Ù¹Ø§:</span> <span id="outNet" style="color:#2ecc71; font-size:20px;">0</span> Ú©Ù„Ùˆ</div>
        <div style="margin-top:15px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <button onclick="saveRecord('Paid')" style="background:#27ae60; color:white; border:none; padding:10px; border-radius:5px; font-weight:bold; grid-column:span 2;">Ù†Ù‚Ø¯ ÙˆØµÙˆÙ„ÛŒ</button>
            <button onclick="saveRecord('Khata')" style="background:#e67e22; color:white; border:none; padding:10px; border-radius:5px; font-weight:bold;">Ú©Ú¾Ø§ØªÛ’ Ù…ÛŒÚº Ù„Ú©Ú¾ÛŒÚº</button>
        </div>
    </div>

    <hr>

    <div class="tab-bar">
        <div class="tab-btn active" onclick="openPage(event, 'pageSum')">Ù…Ø¬Ù…ÙˆØ¹ÛŒ Ú©Ú¾Ø§ØªÛ</div>
        <div class="tab-btn" onclick="openPage(event, 'pageDaily')">Ø±ÙˆØ²Ù…Ø±Û Ø±ÛŒÚ©Ø§Ø±Úˆ</div>
    </div>

    <div id="pdfContent">
        <div id="pdfHeader" style="display:none; text-align:center;">
            <h1 style="color:#2e7d32;">Ø¢Ù¹Ø§ Ú†Ú©ÛŒ Ù…Ø¬Ù…ÙˆØ¹ÛŒ Ú©Ú¾Ø§ØªÛ Ø±Ù¾ÙˆØ±Ù¹</h1>
            <p id="pdfDateRange"></p>
        </div>

        <div class="no-print" style="margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap;">
            <input type="date" id="dateFrom" onchange="renderTables()" style="padding:5px;">
            <input type="date" id="dateTo" onchange="renderTables()" style="padding:5px;">
            <button class="btn-pdf" onclick="downloadPDF()">ğŸ“¥ Ù¾ÛŒ ÚˆÛŒ Ø§ÛŒÙ ÚˆØ§Ø¤Ù† Ù„ÙˆÚˆ Ú©Ø±ÛŒÚº</button>
        </div>

        <div class="report-grid">
            <div class="report-card"><h4>Ú©Ù„ Ú¯Ù†Ø¯Ù…</h4><p id="repWheat">0 Ú©Ù„Ùˆ</p></div>
            <div class="report-card"><h4>Ú©Ù„ Ø±Ù‚Ù…</h4><p id="repMoney">0</p></div>
            <div class="report-card"><h4>Ú©Ù¹ÙˆØªÛŒ ÙˆØ²Ù†</h4><p id="repKatWeight">0 Ú©Ù„Ùˆ</p></div>
            <div class="report-card"><h4>Ú©Ù¹ÙˆØªÛŒ Ø±Ù‚Ù…</h4><p id="repKatCash">0</p></div>
        </div>

        <div id="pageSum" class="tab-page active">
            <table id="tblSummary">
                <thead><tr><th>Ú¯Ø§ÛÚ© Ú©Ø§ Ù†Ø§Ù…</th><th>Ù¹ÙˆÙ¹Ù„ Ø¨Ù„</th><th>Ù¹ÙˆÙ¹Ù„ ÙˆØµÙˆÙ„ÛŒ</th><th>Ø¨Ù‚Ø§ÛŒØ§</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="pageDaily" class="tab-page">
            <table id="tblDaily">
                <thead><tr><th>ØªØ§Ø±ÛŒØ®</th><th>Ù†Ø§Ù…</th><th>ÙˆØ²Ù†</th><th>Ø¨Ù„</th><th>Ø­Ø§Ù„Øª</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>



<script>
    let db = JSON.parse(localStorage.getItem('atta_pro_v8')) || [];
    let tempEntry = null;

    function appInit() { renderTables(); }

    function calculate() {
        const name = document.getElementById('custName').value.trim();
        const weight = parseFloat(document.getElementById('wtInput').value);
        const rate = parseFloat(document.getElementById('rateInput').value);
        const adv = parseFloat(document.getElementById('advInput').value) || 0;

        if (!name || isNaN(weight)) { alert("Ù†Ø§Ù… Ø§ÙˆØ± ÙˆØ²Ù† Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚº"); return; }

        let pisai = 3.00, safai = 1.20, kRate = 0.050;
        let fee = (weight * pisai) + (document.getElementById('checkSafai').checked ? 0 : (weight * safai));
        let katotiWeight = weight * kRate;
        let katotiCashValue = katotiWeight * rate;

        let isKatotiInCash = document.getElementById('checkKatoti').checked;
        let finalBill = fee + (isKatotiInCash ? katotiCashValue : 0);
        let netFlour = weight - (isKatotiInCash ? 0 : katotiWeight) - adv;

        if (document.getElementById('checkPayByFlour').checked) {
            netFlour -= (finalBill / rate);
            finalBill = 0;
        }

        tempEntry = {
            id: Date.now(), name, weight, totalBill: finalBill,
            katWeightTaken: (isKatotiInCash ? 0 : katotiWeight),
            katCashTaken: (isKatotiInCash ? katotiCashValue : 0),
            paid: 0, balance: finalBill, date: new Date().toISOString().split('T')[0]
        };

        document.getElementById('outBill').innerText = finalBill.toFixed(0);
        document.getElementById('outNet').innerText = netFlour.toFixed(2);
        document.getElementById('resPanel').style.display = 'block';
    }

    function saveRecord(status) {
        if (!tempEntry) return;
        tempEntry.status = status;
        if (status === 'Paid') { tempEntry.paid = tempEntry.totalBill; tempEntry.balance = 0; }
        db.push(tempEntry);
        localStorage.setItem('atta_pro_v8', JSON.stringify(db));
        document.getElementById('resPanel').style.display = 'none';
        renderTables();
    }

    function renderTables() {
        const from = document.getElementById('dateFrom').value;
        const to = document.getElementById('dateTo').value;
        const dailyBody = document.querySelector('#tblDaily tbody');
        const summaryBody = document.querySelector('#tblSummary tbody');
        dailyBody.innerHTML = ''; summaryBody.innerHTML = '';

        let stats = { w:0, bill:0, katW:0, katC:0 };
        let customerMap = {};

        db.forEach(item => {
            if ((from && item.date < from) || (to && item.date > to)) return;

            stats.w += item.weight; stats.bill += item.totalBill;
            stats.katW += (item.katWeightTaken || 0); stats.katC += (item.katCashTaken || 0);

            dailyBody.innerHTML += `<tr><td>${item.date}</td><td>${item.name}</td><td>${item.weight}</td><td>${item.totalBill.toFixed(0)}</td><td>${item.status==='Paid'?'Ù†Ù‚Ø¯':'Ø§Ø¯Ú¾Ø§Ø±'}</td></tr>`;

            let n = item.name.trim();
            if (!customerMap[n]) { customerMap[n] = { bill:0, paid:0, bal:0 }; }
            customerMap[n].bill += item.totalBill; customerMap[n].paid += item.paid; customerMap[n].bal += item.balance;
        });

        Object.keys(customerMap).forEach(name => {
            let c = customerMap[name];
            summaryBody.innerHTML += `<tr><td>${name}</td><td>${c.bill.toFixed(0)}</td><td>${c.paid.toFixed(0)}</td><td>${c.bal.toFixed(0)}</td></tr>`;
        });

        document.getElementById('repWheat').innerText = stats.w.toFixed(1) + " Ú©Ù„Ùˆ";
        document.getElementById('repMoney').innerText = stats.bill.toFixed(0);
        document.getElementById('repKatWeight').innerText = stats.katW.toFixed(2) + " Ú©Ù„Ùˆ";
        document.getElementById('repKatCash').innerText = stats.katC.toFixed(0);
    }

    // PDF ÙÙ†Ú©Ø´Ù†
    function downloadPDF() {
        const element = document.getElementById('pdfContent');
        const header = document.getElementById('pdfHeader');
        const from = document.getElementById('dateFrom').value || "Ø§Ø¨ØªØ¯Ø§";
        const to = document.getElementById('dateTo').value || "Ø¢Ø¬";
        
        document.getElementById('pdfDateRange').innerText = `Ø±Ù¾ÙˆØ±Ù¹ Ø¯ÙˆØ±Ø§Ù†ÛŒÛ: ${from} ØªØ§ ${to}`;
        header.style.display = 'block'; // PDF Ú©Û’ Ù„ÛŒÛ’ ÛÛŒÚˆØ± Ø¯Ú©Ú¾Ø§Ø¦ÛŒÚº

        const opt = {
            margin: 10,
            filename: `Chaki_Report_${to}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(element).save().then(() => {
            header.style.display = 'none'; // ÚˆØ§Ø¤Ù† Ù„ÙˆÚˆ Ú©Û’ Ø¨Ø¹Ø¯ ÙˆØ§Ù¾Ø³ Ú†Ú¾Ù¾Ø§ Ø¯ÛŒÚº
        });
    }

    function openPage(evt, pageId) {
        document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        evt.currentTarget.classList.add('active');
    }
</script>
</body>
</html>
